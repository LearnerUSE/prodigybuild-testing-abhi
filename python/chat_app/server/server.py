This code is too long to be converted into a single code block.